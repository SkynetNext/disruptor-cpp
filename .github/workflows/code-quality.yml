name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  # Run on schedule (weekly) to catch regressions
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

jobs:
  # Sanitizers: ASan + UBSan + LSan (combined, most common)
  sanitizer-asan-ubsan:
    name: Sanitizer - ASan+UBSan+LSan
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
          g++ --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            liblz4-dev \
            libpthread-stubs0-dev

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (ASan+UBSan)
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_COMPILER=gcc
            -DCMAKE_CXX_COMPILER=g++
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=OFF
            -DBUILD_EXAMPLES=ON
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=OFF
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1"
            -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1"
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"
          )
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build build --config Debug --parallel 2

      - name: Run tests
        env:
          ASAN_OPTIONS: "detect_leaks=1:check_initialization_order=1:strict_init_order=1:alloc_dealloc_mismatch=0"
          UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1"
        run: |
          cd build
          ctest --output-on-failure -E "Perf.*" --parallel 2 --timeout 300

  # MemorySanitizer + UBSan (detects uninitialized memory reads)
  sanitizer-msan:
    name: Sanitizer - MSan+UBSan
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" -y
          sudo apt-get update
          sudo apt-get install -y clang-19 clang-tools-19
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100
          sudo update-alternatives --set clang /usr/bin/clang-19
          sudo update-alternatives --set clang++ /usr/bin/clang++-19
          clang++ --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            liblz4-dev \
            libpthread-stubs0-dev

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (MSan+UBSan)
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_COMPILER=/usr/bin/clang-19
            -DCMAKE_CXX_COMPILER=/usr/bin/clang++-19
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=OFF
            -DBUILD_EXAMPLES=ON
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=OFF
            -DCMAKE_CXX_FLAGS="-fsanitize=memory,undefined -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1 -fsanitize-memory-track-origins"
            -DCMAKE_C_FLAGS="-fsanitize=memory,undefined -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1 -fsanitize-memory-track-origins"
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=memory,undefined"
          )
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build build --config Debug --parallel 2

      - name: Create MSan suppressions file
        run: |
          # Create suppressions file for MSan false positives in GoogleTest initialization
          cat > msan_suppressions.txt << 'EOF'
          # Suppress false positives from GoogleTest global initialization
          # These occur because system libraries (libstdc++) are not instrumented with MSan
          use-of-uninitialized-value:*/libstdc++.so*
          use-of-uninitialized-value:*gtest*
          EOF
          cat msan_suppressions.txt

      - name: Run tests
        env:
          # MSan options:
          # - check_initialization_order=0: Disable initialization order checking (reduces false positives from global constructors)
          # - poison_in_dtor=0: Don't poison memory in destructors (reduces false positives from system libraries)
          # - print_stats=1: Print statistics
          # - halt_on_error=1: Stop on first error
          # - suppressions: Use suppression file to ignore known false positives
          MSAN_OPTIONS: "check_initialization_order=0:poison_in_dtor=0:print_stats=1:halt_on_error=1:suppressions=${{ github.workspace }}/msan_suppressions.txt"
          UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1"
        run: |
          cd build
          ctest --output-on-failure -E "Perf.*" --parallel 2 --timeout 300

  # ThreadSanitizer (must run separately, cannot combine with other sanitizers)
  sanitizer-tsan:
    name: Sanitizer - TSan
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
          g++ --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            liblz4-dev \
            libpthread-stubs0-dev

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (TSan)
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_COMPILER=gcc
            -DCMAKE_CXX_COMPILER=g++
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=OFF
            -DBUILD_EXAMPLES=ON
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=OFF
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1"
            -DCMAKE_C_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -fno-sanitize-recover=all -g -O1"
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread"
          )
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build build --config Debug --parallel 2

      - name: Run tests
        env:
          TSAN_OPTIONS: "halt_on_error=1:history_size=7"
        run: |
          cd build
          ctest --output-on-failure -E "Perf.*" --parallel 2 --timeout 300

  # Static Analysis: clang-tidy
  static-analysis:
    name: Static Analysis - clang-tidy
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Clang
        run: |
          sudo apt-get update
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" -y
          sudo apt-get update
          sudo apt-get install -y clang-19 clang-tools-19
          clang-tidy --version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            liblz4-dev \
            libpthread-stubs0-dev \
            python3

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_COMPILER=/usr/bin/clang-19
            -DCMAKE_CXX_COMPILER=/usr/bin/clang++-19
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=OFF
            -DBUILD_EXAMPLES=ON
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=OFF
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          )
          cmake "${CMAKE_ARGS[@]}"

      - name: Build (to generate complete compile_commands.json)
        run: |
          # Build at least some targets to ensure compile_commands.json is complete
          cmake --build build --config Debug --parallel 2 --target disruptor_cpp_tests || true

      - name: Verify compile_commands.json
        run: |
          if [ -f build/compile_commands.json ]; then
            echo "✓ compile_commands.json found"
            echo "Entries: $(jq length build/compile_commands.json 2>/dev/null || echo 'unknown')"
          else
            echo "::warning::compile_commands.json not found, clang-tidy may have issues"
          fi

      - name: Run clang-tidy
        run: |
          # Check if .clang-tidy config exists
          if [ ! -f .clang-tidy ]; then
            echo "::warning::.clang-tidy config file not found, using default checks"
          fi
          
          # Verify clang-tidy is available
          if ! command -v clang-tidy &> /dev/null; then
            echo "::error::clang-tidy not found in PATH"
            exit 1
          fi
          
          # Verify compile_commands.json exists
          if [ ! -f build/compile_commands.json ]; then
            echo "::error::compile_commands.json not found, cannot run clang-tidy"
            exit 1
          fi
          
          # Run clang-tidy on all source files
          # Ignore file-not-found errors as they may be false positives
          ERROR_COUNT=0
          TOTAL_FILES=0
          
          # Use process substitution to avoid subshell issues with ERROR_COUNT
          while IFS= read -r file; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            TOTAL_FILES=$((TOTAL_FILES + 1))
            echo "Checking $file ($TOTAL_FILES)..."
            
            # Run clang-tidy and capture output
            OUTPUT=$(clang-tidy "$file" \
              -p build \
              --config-file=.clang-tidy 2>&1 || true)
            
            # Filter out file-not-found errors and other benign warnings
            FILTERED=$(echo "$OUTPUT" | grep -v "file not found" | \
              grep -v "Unable to find" | \
              grep -v "No such file" | \
              grep -v "^$" || true)
            
            # Check for actual code issues (warnings/errors that are not file-not-found)
            if [ -n "$FILTERED" ] && echo "$FILTERED" | grep -qE "(error|warning):"; then
              echo "::error file=$file::clang-tidy issues found"
              echo "$FILTERED"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find include tests examples benchmarks -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
            grep -v third_party | \
            grep -v reference)
          
          echo "Checked $TOTAL_FILES files"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "::error::Found $ERROR_COUNT file(s) with clang-tidy issues"
            exit 1
          fi
          
          echo "✓ clang-tidy check passed (file-not-found errors ignored)"

  # Static Analysis: cppcheck
  static-analysis-cppcheck:
    name: Static Analysis - cppcheck
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck
          cppcheck --version

      - name: Run cppcheck
        run: |
          # Run cppcheck on source files
          # Exclude third-party code and build directories
          # Suppress missingInclude (cppcheck doesn't know CMake include paths)
          # Suppress style warnings that are acceptable in test/example code
          cppcheck \
            --enable=all \
            --suppress=missingInclude \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --suppress=useStlAlgorithm \
            --suppress=constParameterReference \
            --suppress=constParameterCallback \
            --inline-suppr \
            --std=c++26 \
            --platform=unix64 \
            --error-exitcode=1 \
            --xml \
            --xml-version=2 \
            --output-file=cppcheck-report.xml \
            include tests examples benchmarks \
            -i third_party \
            -i reference \
            -i build \
            -i .git \
            || true
          
          # Also output to console for visibility (only errors and warnings, not info)
          cppcheck \
            --enable=warning,error \
            --suppress=missingInclude \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --suppress=useStlAlgorithm \
            --suppress=constParameterReference \
            --suppress=constParameterCallback \
            --inline-suppr \
            --std=c++26 \
            --platform=unix64 \
            --error-exitcode=1 \
            include tests examples benchmarks \
            -i third_party \
            -i reference \
            -i build \
            -i .git

      - name: Upload cppcheck report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 7

  # Code Formatting: clang-format check
  code-format:
    name: Code Format - clang-format
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup clang-format
        run: |
          sudo apt-get update
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main" -y
          sudo apt-get update
          sudo apt-get install -y clang-format-19
          clang-format-19 --version

      - name: Check code formatting
        run: |
          # Check formatting on changed files (for PRs) or all files (for push)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check only changed files
            FILES=$(git diff --name-only --diff-filter=ACMRTUXB origin/${{ github.base_ref }}...HEAD | \
              grep -E '\.(cpp|hpp|h)$' | \
              grep -v third_party | \
              grep -v reference || true)
          else
            # For pushes, check all source files
            FILES=$(find include tests examples benchmarks -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
              grep -v third_party | \
              grep -v reference || true)
          fi
          
          if [ -z "$FILES" ]; then
            echo "No C++ files to check"
            exit 0
          fi
          
          # Check formatting
          MISFORMATTED=""
          COUNT=0
          for file in $FILES; do
            if [ -f "$file" ]; then
              if ! clang-format-19 "$file" | diff -q "$file" - > /dev/null 2>&1; then
                echo "::error file=$file::Formatting issue detected"
                MISFORMATTED="$MISFORMATTED $file"
                COUNT=$((COUNT + 1))
                # Show first few differences for debugging
                if [ $COUNT -le 3 ]; then
                  echo "=== Diff for $file (first 20 lines) ==="
                  clang-format-19 "$file" | diff -u "$file" - | head -20 || true
                fi
              fi
            fi
          done
          
          if [ -n "$MISFORMATTED" ]; then
            echo "::error::Found $COUNT file(s) with formatting issues"
            echo ""
            echo "To fix all files, run:"
            echo "  find include tests examples benchmarks -name '*.cpp' -o -name '*.hpp' -o -name '*.h' | grep -v third_party | grep -v reference | xargs clang-format-19 -i"
            echo ""
            echo "Or fix individual files:"
            echo "  clang-format-19 -i <file>"
            exit 1
          fi
          
          echo "✓ All files are properly formatted"

  # Code Coverage: gcov/lcov
  code-coverage:
    name: Code Coverage - gcov/lcov
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
          # gcov is included with gcc-14, find and set it up
          # In Ubuntu, gcov may be at /usr/lib/gcc/x86_64-linux-gnu/14/gcov or /usr/bin/gcov
          if [ -f /usr/lib/gcc/x86_64-linux-gnu/14/gcov ]; then
            sudo update-alternatives --install /usr/bin/gcov gcov /usr/lib/gcc/x86_64-linux-gnu/14/gcov 100
          elif [ -f /usr/bin/gcov-14 ]; then
            sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-14 100
          fi
          g++ --version
          gcov --version || echo "Note: gcov version check skipped"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            liblz4-dev \
            libpthread-stubs0-dev \
            lcov

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.30'

      - name: Configure CMake (with coverage)
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -G Ninja
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_COMPILER=gcc
            -DCMAKE_CXX_COMPILER=g++
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=OFF
            -DBUILD_EXAMPLES=ON
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=OFF
            -DCMAKE_CXX_FLAGS="--coverage -g -O0"
            -DCMAKE_C_FLAGS="--coverage -g -O0"
            -DCMAKE_EXE_LINKER_FLAGS="--coverage"
          )
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build build --config Debug --parallel 2

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure -E "Perf.*" --parallel 2 --timeout 300

      - name: Generate coverage report
        run: |
          cd build
          # Verify gcov version matches compiler
          gcov --version || echo "Using gcov from PATH"
          # Find gcov tool for GCC 14
          if [ -f /usr/lib/gcc/x86_64-linux-gnu/14/gcov ]; then
            GCOV_TOOL="/usr/lib/gcc/x86_64-linux-gnu/14/gcov"
          elif [ -f /usr/bin/gcov-14 ]; then
            GCOV_TOOL="gcov-14"
          else
            GCOV_TOOL="gcov"
          fi
          echo "Using gcov tool: $GCOV_TOOL"
          # Collect coverage data using geninfo directly for better error control
          # --ignore-errors mismatch: Ignore line number mismatches (common with modern GCC/Clang)
          # --ignore-errors gcov: Ignore gcov parsing warnings (unexecuted blocks, etc.)
          geninfo . --output-filename coverage.info --gcov-tool "$GCOV_TOOL" \
            --ignore-errors mismatch,gcov || {
            echo "::warning::Some coverage data collection warnings occurred, but continuing..."
            # If geninfo fails completely, try to continue with partial data
            if [ ! -f coverage.info ]; then
              echo "::error::Failed to generate coverage.info"
              exit 1
            fi
          }
          # Remove coverage for third-party code, reference code, and test files
          lcov --remove coverage.info \
            '*/third_party/*' \
            '*/reference/*' \
            '*/build/_deps/*' \
            '*/tests/*' \
            '*/examples/*' \
            '*/benchmarks/*' \
            --output-file coverage.info
          # Generate HTML report
          genhtml coverage.info --output-directory coverage-report
          # Print summary
          lcov --list coverage.info

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage-report
          retention-days: 30

      - name: Coverage summary
        run: |
          cd build
          echo "=== Coverage Summary ==="
          lcov --summary coverage.info || true
