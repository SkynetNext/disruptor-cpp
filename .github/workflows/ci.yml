name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test:
    name: Test - Linux
    # C++26 requires GCC 14+ / Clang 19+
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        compiler: [gcc, clang]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup GCC
        if: matrix.compiler == 'gcc'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100

      - name: Setup Clang
        if: matrix.compiler == 'clang'
        run: |
          sudo apt-get update
          # Install GCC 14 first to get libstdc++ with C++23 support (std::expected)
          sudo apt-get install -y gcc-14 g++-14
          sudo apt-get install -y clang-19
          # Install alternatives and explicitly set them
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100
          # Explicitly select Clang 19 (--set is required, --install alone doesn't select)
          sudo update-alternatives --set clang /usr/bin/clang-19
          sudo update-alternatives --set clang++ /usr/bin/clang++-19
          # Verify the selection
          echo "Clang version:"
          clang++ --version
          echo "Clang path:"
          which clang++

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          # CMake 3.30+ required for full cxx_std_26 support
          cmake-version: "3.30"

      - name: Configure CMake
        shell: bash
        run: |
          CMAKE_ARGS=(
            -B build
            -DCMAKE_BUILD_TYPE=Release
            -DBUILD_TESTING=ON
            -DBUILD_BENCHMARKS=ON
            -DBUILD_EXAMPLES=ON
          )
          if [ "${{ matrix.compiler }}" == "gcc" ]; then
            CMAKE_ARGS+=(-DCMAKE_CXX_COMPILER=g++)
          else
            # Use explicit path to ensure Clang 19 is used
            CMAKE_ARGS+=(-DCMAKE_CXX_COMPILER=/usr/bin/clang++-19)
            # Ensure Clang uses GCC 14's libstdc++ for C++23 features like std::expected
            CMAKE_ARGS+=(-DCMAKE_CXX_FLAGS="-stdlib=libstdc++")
            # Also set C compiler to avoid mismatch
            CMAKE_ARGS+=(-DCMAKE_C_COMPILER=/usr/bin/clang-19)
            echo "Using Clang 19 with GCC 14 libstdc++"
            /usr/bin/clang++-19 --version
          fi
          # CMakeLists.txt sets CMAKE_CXX_STANDARD=26, CMake will handle the compiler flag
          cmake "${CMAKE_ARGS[@]}"

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure --parallel

      - name: Run Benchmarks
        run: |
          cd build
          ./benchmarks/disruptor_cpp_benchmarks \
            --benchmark_format=json \
            --benchmark_out=benchmark_results_cpp.json \
            --benchmark_min_time=0.5 || true

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-cpp-${{ matrix.compiler }}
          path: build/benchmark_results_cpp.json
          if-no-files-found: ignore

  benchmark-comparison:
    name: Performance Comparison - C++ vs Java Disruptor
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential numactl
          # Install GCC 14 for C++26 support
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          # CMake 3.30+ required for full cxx_std_26 support
          cmake-version: "3.30"

      - name: Build C++ benchmarks
        run: |
          # CMakeLists.txt sets CMAKE_CXX_STANDARD=26, CMake will handle the compiler flag
          # Explicitly set compiler to ensure GCC 14 is used
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DBUILD_TESTING=OFF \
            -DBUILD_BENCHMARKS=ON
          cmake --build build --config Release --parallel

      - name: Run C++ Benchmarks
        run: |
          cd build
          echo "=========================================="
          echo "C++ Disruptor Benchmarks (End-to-End: SPSC & MPSC)"
          echo "=========================================="
          # Parameters match Java JMH: -wi 2 -w 5s -i 3 -r 5s
          # -wi 2 -w 5s: 2 warmup iterations, 5s each = 10s total warmup
          # -i 3 -r 5s: 3 measurement iterations, 5s each
          # Note: benchmark_min_warmup_time is double (seconds), not string like benchmark_min_time
          ./benchmarks/disruptor_cpp_benchmarks \
            --benchmark_min_warmup_time=10 \
            --benchmark_min_time=5s \
            --benchmark_repetitions=3 \
            --benchmark_filter="JMH_SingleProducerSingleConsumer_producing|JMH_MultiProducerSingleConsumer_producing"
          cd ..

      - name: Build Java Disruptor
        working-directory: reference/disruptor
        run: |
          chmod +x gradlew
          ./gradlew jmhJar --no-daemon

      - name: "Run Java Disruptor JMH Benchmarks (End-to-End: SPSC & MPSC)"
        working-directory: reference/disruptor
        run: |
          echo "=========================================="
          echo "Java Disruptor Benchmarks (End-to-End: SPSC & MPSC)"
          echo "=========================================="
          # Run ONLY end-to-end tests matching C++ benchmarks:
          # - SingleProducerSingleConsumer (SPSC)
          # - MultiProducerSingleConsumer (MPSC)
          #
          # Parameters (matching C++):
          # -f 1: 1 fork
          # -wi 2 -w 5s: 2 warmup iterations, 5s each (10s total warmup)
          # -i 3 -r 5s: 3 measurement iterations, 5s each
          java -jar build/libs/*-jmh.jar \
            -foe true -v NORMAL \
            -f 1 -wi 2 -w 5s -i 3 -r 5s \
            ".*(SingleProducerSingleConsumer|MultiProducerSingleConsumer).*"

      - name: Run C++ OneToOneSequencedThroughputTest (End-to-End Throughput)
        run: |
          cd build
          echo "=========================================="
          echo "C++ OneToOneSequencedThroughputTest (End-to-End Throughput)"
          echo "=========================================="
          # This is a throughput test (100M iterations), not a micro-benchmark
          # It runs 7 iterations by default (matching Java's AbstractPerfTestDisruptor.RUNS = 7)
          ./benchmarks/disruptor_cpp_benchmarks \
            --benchmark_filter="PerfTest_OneToOneSequencedThroughputTest" \
            --benchmark_min_time=1s \
            --benchmark_repetitions=1
          cd ..

      - name: Run Java OneToOneSequencedThroughputTest (End-to-End Throughput)
        working-directory: reference/disruptor
        run: |
          echo "=========================================="
          echo "Java OneToOneSequencedThroughputTest (End-to-End Throughput)"
          echo "=========================================="
          # Build perftest classes
          ./gradlew perftestClasses --no-daemon
          # Run the test (matches C++: 7 runs, 100M iterations each)
          bash ../../scripts/run_java_perftest.sh
